pipeline {
    agent any                        // тот же сервер, где стоит Jenkins
    tools {                          // предварительно добавьте в «Global Tool Configuration»
        jdk   'jdk17'               // Temurin 17 (или другое имя, если задали своё)
        maven 'maven3'              // Maven 3.x
    }

    environment {
        IMAGE_NAME        = 'marmevladek/devopsl-backend'
        DOCKER_HUB_USER   = credentials('DOCKER_HUB_USERNAME')
        DOCKER_HUB_TOKEN  = credentials('DOCKER_HUB_TOKEN')
        SONAR_TOKEN       = credentials('SONAR_TOKEN')
    }

    stages {

        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Build (skip tests)') {
            steps {
                dir('backend-service') {
                    sh 'mvn clean install -DskipTests'
                }
            }
        }

        stage('Test') {
            steps {
                dir('backend-service') {
                    sh 'mvn test'
                }
            }
            post {
                always { junit 'backend-service/target/surefire-reports/*.xml' }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                dir('backend-service') {
                    withSonarQubeEnv('SonarQubeServer') {
                        sh """
                            mvn clean verify sonar:sonar \
                              -Dsonar.projectKey=devopsl-backend \
                              -Dsonar.projectName='devopsl-backend'
                        """
                    }
                }
            }
        }
        stage('Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

    }
}
